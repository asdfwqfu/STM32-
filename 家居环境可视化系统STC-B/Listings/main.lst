C51 COMPILER V9.54   MAIN                                                                  12/20/2023 22:18:27 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: F:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(.\inc) DEBUG OBJECTEXTEND PRINT(.
                    -\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include "STC15F2K60S2.H"        //±ØÐë¡£
   2          #include "sys.H"                 //±ØÐë¡£
   3          #include "EXT.h" 
   4          #include "key.h"
   5          #include "displayer.h"
   6          #include "adc.h"
   7          #include "beep.H" 
   8          #include "ir.h"
   9          #include "uart1.h"
  10          #include "music.h"
  11          #include "uart2.h"
  12          #include "time.h"
  13          #include "FM_Radio.h"
  14          #include "M24C02.h"
  15          
  16          code unsigned long SysClock=11059200;         //±ØÐë¡£¶¨ÒåÏµÍ³¹¤×÷Ê±ÖÓÆµÂÊ(Hz)£¬ÓÃ»§±ØÐëÐÞ¸Ä³ÉÓëÊµ¼Ê¹¤×÷Æµ
             -ÂÊ£¨ÏÂÔØÊ±Ñ¡ÔñµÄ£©Ò»ÖÂ
  17          #ifdef _displayer_H_                          //ÏÔÊ¾Ä£¿éÑ¡ÓÃÊ±±ØÐë¡££¨ÊýÂë¹ÜÏÔÊ¾ÒëÂë±í£¬ÓÃ‘ô¿ÉÐÞ¸Ä¡¢Ôö¼ÓµÈ
             -£© 
  18          code char decode_table[]={0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,0x07,0x7f,0x6f,0x00,0x08,0x40,0x01,0x41,0x48,
             -0x76,0x38,0x40,0x00,  
  19                          /* ÐòºÅ:   0    1    2     3    4     5    6    7   8     9     10  11   12   13   14   15    16
             -   17   18   19  */
  20                          /* ÏÔÊ¾:   0    1    2     3    4     5    6    7   8    9  (ÎÞ)   ÏÂ-  ÖÐ-  ÉÏ-  ÉÏÖÐ-  Ö
             -ÐÏÂ-  H    L    -   £¨ÎÞ£©*/  
  21                                   0x3f|0x80,0x06|0x80,0x5b|0x80,0x4f|0x80,0x66|0x80,0x6d|0x80,0x7d|0x80,0x07|0x80,0x
             -7f|0x80,0x6f|0x80 };  
  22                       /* ´øÐ¡Êýµã     20         21         22         23      24        25        26        27    
             -    28        29        */
  23          #endif
  24          #define DS1302_SECOND_WRITE 0x80      
  25          #define DS1302_MINUTE_WRITE 0x82
  26          #define DS1302_HOUR_WRITE   0x84
  27          #define DS1302_SECOND_READ  0x81
  28          int code tempdata[]={239,197,175,160,150,142,135,129,124,120,116,113,109,107,104,101, 
  29                                99, 97, 95, 93, 91, 90, 88, 86, 85, 84, 82, 81, 80, 78, 77, 76, 
  30                                75, 74, 73, 72, 71, 70, 69, 68, 67, 67, 66, 65, 64, 63, 63, 62, 
  31                                61, 61, 60, 59, 58, 58, 57, 57, 56, 55, 55, 54, 54, 53, 52, 52, 
  32                                51, 51, 50, 50, 49, 49, 48, 48, 47, 47, 46, 46, 45, 45, 44, 44, 
  33                                43, 43, 42, 42, 41, 41, 41, 40, 40, 39, 39, 38, 38, 38, 37, 37, 
  34                                36, 36, 36, 35, 35, 34, 34, 34, 33, 33, 32, 32, 32, 31, 31, 31, 
  35                                30, 30, 29, 29, 29, 28, 28, 28, 27, 27, 27, 26, 26, 26, 25, 25,
  36                                24, 24, 24, 23, 23, 23, 22, 22, 22, 21, 21, 21, 20, 20, 20, 19, 
  37                                19, 19, 18, 18, 18, 17, 17, 16, 16, 16, 15, 15, 15, 14, 14, 14, 
  38                                13, 13, 13, 12, 12, 12, 11, 11, 11, 10, 10, 9, 9, 9, 8, 8, 8, 7, 
  39                                7, 7, 6, 6,5, 5, 5,4,4, 3, 3,3, 2, 2, 1, 1, 1, 0, 0, -1, -1, -1, 
  40                                -2, -2, -3, -3, -4, -4, -5, -5, -6, -6, -7, -7, -8, -8, -9, -9, 
  41                                -10, -10, -11, -11, -12, -13, -13, -14, -14, -15, -16, -16, -17, 
  42                                -18, -19, -19, -20, -21, -22, -23, -24, -25, -26, -27, -28, -29, 
  43                                -30, -32, -33, -35, -36, -38, -40, -43, -46, -50, -55, -63, 361};
  44          unsigned char model=1;//Ä£Ê½
  45          unsigned char flag=0;//¶¨Ê±ÅÐ¶Ï
  46          unsigned char light=0;//¹âÕÕ
  47          unsigned int suml=0;//¹âÕÕºÍ
C51 COMPILER V9.54   MAIN                                                                  12/20/2023 22:18:27 PAGE 2   

  48          unsigned char temperature=0;//¹âÕÕºÍ
  49          RTC_TimeTypeDef time;
  50          unsigned int sumt=0;//ÎÂ¶ÈºÍ
  51          unsigned char freq=0;//adc´ÎÊý
  52          struct_ADC adc_data;//adcÊý¾Ý
  53          unsigned char led=0;//µÆÅÝ¹âÁÁ
  54          struct_FMRadio FM = {975,5,0,1,1};
  55          unsigned char alarmhour;  
  56          unsigned char alarmminute;  
  57          unsigned char alarmsecond;
  58          unsigned char modifimodel;
  59          unsigned char nowhourlow;
  60          unsigned char nowminutelow;
  61          unsigned char nowsecondlow;
  62          unsigned char nowhourhigh;
  63          unsigned char nowminutehigh;
  64          unsigned char nowsecondhigh;
  65          unsigned char wei;
  66          unsigned char key2_falg;
  67          unsigned char key3_falg;
  68          uchar dtime;
  69          code  uchar table_D_BCD[]={0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09};
  70          code char matchhead[2]={0xaa,0x55};
  71          unsigned char sentdata[8]={0,0,0,0,0,0,0,0};
  72          unsigned char sendflag=0;
  73          char save[8]={0,0,0,0,0,0,0,0};//´®¿Ú½ÓÊÕÊý¾Ý
  74          
  75          void keycallback()
  76          {
  77   1          if(GetKeyAct(enumKey1)==enumKeyPress){
  78   2              if(++model>4)model=1;
  79   2            }
  80   1          else if(GetKeyAct(enumKey2)==enumKeyPress){
  81   2                key2_falg=1-key2_falg;
  82   2                if(key2_falg==1)led=led|0x0f;
  83   2                else led=led&0xf0;
  84   2            }
  85   1          else if(GetKeyAct(enumKey3)==enumKeyPress){
  86   2      
  87   2            } 
  88   1      }
  89          void displaycallback()
  90          {
  91   1          LedPrint(led);
  92   1            time=DS1302_GetTime();
  93   1            adc_data = GetADC();
  94   1            suml+=adc_data.Rop;
  95   1            adc_data = GetADC();
  96   1            sumt+=adc_data.Rt/4;
  97   1            freq++;
  98   1            if(freq==250)
  99   1            {
 100   2              light=(suml+freq/2)/freq;
 101   2              temperature=(sumt+freq/2)/freq;
 102   2              temperature=tempdata[temperature-1];
 103   2              freq=0;
 104   2              suml=0;
 105   2              sumt=0;
 106   2            }
 107   1        
 108   1        if(model==1 && modifimodel==0)Seg7Print(time.Hours/10,time.Hours%10,10,time.Minutes/10,time.Minutes%10,10
             -,time.Seconds/10,time.Seconds%10);
C51 COMPILER V9.54   MAIN                                                                  12/20/2023 22:18:27 PAGE 3   

 109   1        else if((model==1||model==3 )&& modifimodel==1)
 110   1        {
 111   2          switch(wei)
 112   2          {
 113   3            case 0:
 114   3                Seg7Print(nowhourhigh+20,nowhourlow,10,nowminutehigh,nowminutelow,10,nowsecondhigh,nowsecondlow);
 115   3            break;
 116   3            case 1:
 117   3                Seg7Print(nowhourhigh,nowhourlow+20,10,nowminutehigh,nowminutelow,10,nowsecondhigh,nowsecondlow);
 118   3            break;
 119   3            case 3:
 120   3                Seg7Print(nowhourhigh,nowhourlow,10,nowminutehigh+20,nowminutelow,10,nowsecondhigh,nowsecondlow);
 121   3            break;
 122   3            case 4:
 123   3                Seg7Print(nowhourhigh,nowhourlow,10,nowminutehigh,nowminutelow+20,10,nowsecondhigh,nowsecondlow);
 124   3            break;
 125   3            case 6:
 126   3                Seg7Print(nowhourhigh,nowhourlow,10,nowminutehigh,nowminutelow,10,nowsecondhigh+20,nowsecondlow);
 127   3            break;
 128   3            case 7:
 129   3                Seg7Print(nowhourhigh,nowhourlow,10,nowminutehigh,nowminutelow,10,nowsecondhigh,nowsecondlow+20);
 130   3            break;
 131   3          }
 132   2        }
 133   1        else if(model==2)Seg7Print(light/100,(light/10)%10,light%10,10,10,10,temperature/10,temperature%10);
 134   1        else if(model==3)Seg7Print(alarmhour/10,alarmhour%10,10,alarmminute/10,alarmminute%10,10,alarmsecond/10,a
             -larmsecond%10);
 135   1        else if(model==4 && FM.volume<10 && FM.frequency<1000)Seg7Print(FM.volume,10,10,10,10,FM.frequency%1000/1
             -00,FM.frequency%1000%100/10+20,FM.frequency%1000%100%10);
 136   1        else if(model==4 && FM.volume<10 && FM.frequency>=1000)Seg7Print(FM.volume,10,10,10,FM.frequency/1000,FM.
             -frequency%1000/100,FM.frequency%1000%100/10+20,FM.frequency%1000%100%10);
 137   1        else if(model==4 && FM.volume>=10 && FM.frequency<1000)Seg7Print(FM.volume/10,FM.volume%10,10,10,10,FM.fr
             -equency%1000/100,FM.frequency%1000%100/10+20,FM.frequency%1000%100%10);
 138   1        else if(model==4 && FM.volume>=10 && FM.frequency>=1000)Seg7Print(FM.volume/10,FM.volume%10,10,10,FM.freq
             -uency/1000,FM.frequency%1000/100,FM.frequency%1000%100/10+20,FM.frequency%1000%100%10);
 139   1        if(time.Hours==alarmhour && time.Minutes==alarmminute && (0<=(time.Seconds-alarmsecond)<=3))SetBeep(100,4
             -0);
 140   1      } 
 141          void nav_callback()
 142          {
 143   1        if(GetAdcNavAct(enumAdcNavKeyUp)==enumKeyPress)
 144   1        {
 145   2          if(model==1||model==3)
 146   2          {
 147   3                          switch(wei)
 148   3                          {
 149   4                            case 0:
 150   4                              if(nowhourhigh<2)nowhourhigh++;
 151   4                              else nowhourhigh=0;
 152   4                              break;
 153   4                            case 1:
 154   4                              if(nowhourhigh<2 && nowhourlow<10)
 155   4                              {
 156   5                                nowhourlow++;
 157   5                                if(nowhourlow==10)
 158   5                                {
 159   6                                  nowhourlow=0;
 160   6                                }
 161   5                              }
 162   4                              else if(nowhourhigh==2 && nowhourlow<4)
 163   4                              {
 164   5                                nowhourlow++;
C51 COMPILER V9.54   MAIN                                                                  12/20/2023 22:18:27 PAGE 4   

 165   5                                if(nowhourlow==4)
 166   5                                {
 167   6                                  nowhourlow=0;
 168   6                                }
 169   5                              }
 170   4                              else nowhourlow=0;
 171   4                              break;
 172   4                             case 3:
 173   4                              if (nowminutehigh < 5)
 174   4                                  nowminutehigh++;
 175   4                              else
 176   4                                  nowminutehigh = 0;
 177   4                              break;
 178   4                          case 4:
 179   4                              if (nowminutelow < 9)
 180   4                                  nowminutelow++;
 181   4                              else
 182   4                                  nowminutelow = 0;
 183   4                              break;
 184   4                          case 6:
 185   4                              if (nowsecondhigh < 5)
 186   4                                  nowsecondhigh++;
 187   4                              else
 188   4                                  nowsecondhigh = 0;
 189   4                              break;
 190   4                          case 7:
 191   4                              if (nowsecondlow < 9)
 192   4                                  nowsecondlow++;
 193   4                              else
 194   4                                  nowsecondlow = 0;
 195   4                              break;
 196   4                          }
 197   3          }
 198   2          if(model==4)
 199   2          {
 200   3            if(FM.volume<15)FM.volume++;
 201   3            else FM.volume=0;
 202   3          }
 203   2        }
 204   1        else if(GetAdcNavAct(enumAdcNavKeyDown)==enumKeyPress)
 205   1        {
 206   2          if(model==1||model==3)
 207   2          {
 208   3              switch(wei)
 209   3              {
 210   4                  case 0:
 211   4                    if(nowhourhigh>0)nowhourhigh--;
 212   4                    else nowhourhigh=2;
 213   4                    break;
 214   4                  case 1:
 215   4                    if(nowhourhigh<2 && nowhourlow>0)nowhourlow--;
 216   4                    else if(nowhourhigh<2 && nowhourlow==0)nowhourlow=9;
 217   4                    else if(nowhourhigh==2 && nowhourlow>0)nowhourlow--;
 218   4                    else if(nowhourhigh==2 && nowhourlow==0)nowhourlow=3;
 219   4                    break;
 220   4                  case 3:
 221   4                    if (nowminutehigh > 0)
 222   4                        nowminutehigh--;
 223   4                    else
 224   4                        nowminutehigh = 5;
 225   4                    break;
 226   4                  case 4:
C51 COMPILER V9.54   MAIN                                                                  12/20/2023 22:18:27 PAGE 5   

 227   4                     if (nowminutelow > 0)
 228   4                         nowminutelow--;
 229   4                     else
 230   4                         nowminutelow = 9;
 231   4                     break;
 232   4                  case 6:
 233   4                     if (nowsecondhigh > 0)
 234   4                         nowsecondhigh--;
 235   4                     else
 236   4                         nowsecondhigh = 5;
 237   4                     break;
 238   4                  case 7:
 239   4                     if (nowsecondlow > 0)
 240   4                         nowsecondlow--;
 241   4                     else
 242   4                         nowsecondlow = 9;
 243   4                     break;
 244   4                          }
 245   3                        }
 246   2          if(model==4)
 247   2          {
 248   3            if(FM.volume>0)FM.volume--;
 249   3            else FM.volume=15;
 250   3          }
 251   2        }
 252   1        else if(GetAdcNavAct(enumAdcNavKeyCenter)==enumKeyPress)
 253   1        {
 254   2          if(model==1||model==3)
 255   2          {
 256   3            modifimodel=1-modifimodel;
 257   3          }
 258   2          if(modifimodel==1 && model==1)
 259   2          {
 260   3            nowhourlow=time.Hours%10;
 261   3            nowminutelow=time.Minutes%10;
 262   3            nowsecondlow=time.Seconds%10;
 263   3            nowhourhigh=time.Hours/10;
 264   3            nowminutehigh=time.Minutes/10;
 265   3            nowsecondhigh=time.Seconds/10;
 266   3          }
 267   2          else if(modifimodel==1 && model==3)
 268   2          {
 269   3            nowhourlow=alarmhour%10;
 270   3            nowminutelow=alarmminute%10;
 271   3            nowsecondlow=alarmsecond%10;
 272   3            nowhourhigh=alarmhour/10;
 273   3            nowminutehigh=alarmminute/10;
 274   3            nowsecondhigh=alarmsecond/10;
 275   3          }
 276   2          else if(modifimodel==0 && model==1)
 277   2          {
 278   3          WriteDS1302(0x8E,0x00);  //½ûÖ¹Ð´±£»¤Î»
 279   3          dtime=ReadDS1302(DS1302_SECOND_READ)|0x80;
 280   3          WriteDS1302(0x80,dtime);//¾§ÕñÍ£Ö¹¹¤×÷
 281   3          /*Ð´ÈëÊ±¡¢·Ö¡¢ÃëÖµ*/   
 282   3          dtime=(table_D_BCD[nowsecondhigh]<<4)|table_D_BCD[nowsecondlow];  
 283   3          WriteDS1302(DS1302_SECOND_WRITE,dtime);
 284   3          dtime=(table_D_BCD[nowminutehigh]<<4)|table_D_BCD[nowminutelow];
 285   3          WriteDS1302(DS1302_MINUTE_WRITE,dtime);
 286   3          dtime=(table_D_BCD[nowhourhigh]<<4)|table_D_BCD[nowhourlow];  
 287   3          WriteDS1302(DS1302_HOUR_WRITE,dtime);
 288   3          WriteDS1302(0x8E,0x80); //Ð´±£»¤Î»ÖÃ1
C51 COMPILER V9.54   MAIN                                                                  12/20/2023 22:18:27 PAGE 6   

 289   3          }
 290   2          else if(modifimodel==0 && model==3)
 291   2          {
 292   3            alarmhour=nowhourhigh*10+nowhourlow;
 293   3            alarmminute=nowminutehigh*10+nowminutelow;
 294   3            alarmsecond=nowsecondhigh*10+nowsecondlow;
 295   3            M24C02_Write(0,alarmhour);
 296   3            M24C02_Write(1,alarmminute);
 297   3            M24C02_Write(2,alarmsecond);
 298   3          }
 299   2      
 300   2        }
 301   1        else if(GetAdcNavAct(enumAdcNavKeyRight)==enumKeyPress)
 302   1        {
 303   2          if(model==1||model==3)
 304   2          {
 305   3            if(wei!=1&&wei!=4&&wei<7)wei++;
 306   3            else if(wei==1||wei==4)wei+=2;
 307   3            else if(wei==7)wei=0;
 308   3          }
 309   2          if(model==4)
 310   2          {
 311   3            if(FM.frequency < 1080)FM.frequency++;
 312   3            else FM.frequency=887;
 313   3          }
 314   2        }
 315   1        else if(GetAdcNavAct(enumAdcNavKeyLeft)==enumKeyPress)
 316   1        {
 317   2          if(model==1||model==3)
 318   2          {
 319   3            if(wei!=3&&wei!=6&&wei>0)wei--;
 320   3            else if(wei==3||wei==6)wei-=2;
 321   3            else if(wei==0)wei=7;
 322   3          }
 323   2          if(model==4)
 324   2          {
 325   3            if(FM.frequency > 887)FM.frequency--;
 326   3            else FM.frequency=1080;
 327   3          }
 328   2        }
 329   1        else if(GetAdcNavAct(enumAdcNavKey3)==enumKeyPress)
 330   1        {
 331   2                key3_falg=1-key3_falg;
 332   2                if(key3_falg==1)led=led|0xf0;
 333   2                else led=led&0x0f;
 334   2        }
 335   1      }
 336          
 337          void sentcallback()
 338          {
 339   1        if(light<40 || temperature<15)IrPrint(sentdata,8);
 340   1        sendflag=1-sendflag;
 341   1        if(sendflag==1)
 342   1        {
 343   2        sentdata[0]=0xAA;
 344   2        sentdata[1]=0x55;
 345   2        sentdata[2]=temperature;
 346   2        sentdata[3]=light;
 347   2        sentdata[4]=led;
 348   2        sentdata[5]=time.Hours;
 349   2        sentdata[6]=time.Minutes;
 350   2        sentdata[7]=time.Seconds;
C51 COMPILER V9.54   MAIN                                                                  12/20/2023 22:18:27 PAGE 7   

 351   2        Uart2Print(sentdata,8);
 352   2        }
 353   1        else if(sendflag==0)
 354   1        {
 355   2        sentdata[0]=0xAA;
 356   2        sentdata[1]=0x56;
 357   2        sentdata[2]=FM.frequency/10;
 358   2        sentdata[3]=FM.frequency%10;
 359   2        sentdata[4]=FM.volume;
 360   2        sentdata[5]=alarmhour;
 361   2        sentdata[6]=alarmminute;
 362   2        sentdata[7]=alarmsecond;
 363   2      
 364   2        }
 365   1        Uart1Print(sentdata,8);
 366   1      
 367   1      }
 368          void comcallback()
 369          {
 370   1        led=save[4];
 371   1        if(save[5]==1)
 372   1        {
 373   2          if(FM.frequency<1080)FM.frequency+=1;
 374   2          else FM.frequency=875;
 375   2        }
 376   1        else if(save[5]==2)
 377   1        {
 378   2          if(FM.frequency>875)FM.frequency-=1;
 379   2          else FM.frequency=1080;
 380   2        }
 381   1        if(save[6]==1)
 382   1        {
 383   2          if(FM.volume<15)FM.volume+=1;
 384   2          else FM.volume=0;
 385   2        }
 386   1        else if(save[6]==2)
 387   1        {
 388   2          if(FM.volume>0)FM.volume-=1;
 389   2          else FM.volume=15;
 390   2        }
 391   1      
 392   1        return;
 393   1      }
 394          void uart485callback()
 395          {
 396   1        led=save[5];
 397   1        FM.frequency=save[2]*10+save[3];
 398   1        FM.volume=save[4];
 399   1        alarmminute=save[6];
 400   1        alarmsecond=save[7];
 401   1        M24C02_Write(1,alarmminute);
 402   1        M24C02_Write(2,alarmsecond);
 403   1      }
 404          void main()
 405          {
 406   1        FMRadioInit(FM);
 407   1        Initial_DS1302();
 408   1        KeyInit();
 409   1        DisplayerInit();
 410   1        IrInit(NEC_R05d);
 411   1        AdcInit(ADCexpEXT);
 412   1        BeepInit(); 
C51 COMPILER V9.54   MAIN                                                                  12/20/2023 22:18:27 PAGE 8   

 413   1        SetDisplayerArea(0,7);
 414   1        Seg7Print(10,10,10,10,10,10,10,10);
 415   1        LedPrint(0);
 416   1        Uart1Init(115200);
 417   1        Uart2Init(115200,Uart2Usedfor485);
 418   1        SetUart1Rxd(save, 8, matchhead, 2);
 419   1        SetUart2Rxd(save, 8, matchhead, 2);
 420   1        alarmhour=M24C02_Read(0);
 421   1        alarmminute=M24C02_Read(1);
 422   1        alarmsecond=M24C02_Read(2);
 423   1        SetEventCallBack(enumEventUart1Rxd,comcallback);
 424   1        SetEventCallBack(enumEventUart2Rxd,uart485callback);
 425   1        SetEventCallBack(enumEventKey,keycallback);//±äËÙ
 426   1        SetEventCallBack(enumEventSys1mS,displaycallback);//ÏÔÊ¾
 427   1        SetEventCallBack(enumEventNav,nav_callback);//µ¼º½¼ü
 428   1        SetEventCallBack(enumEventSys100mS,sentcallback);//·¢ËÍÊý¾Ý
 429   1        //SetEventCallBack(enumEventSys1S,ircallback);//·¢ËÍÊý¾Ý
 430   1        MySTC_Init();     
 431   1        while(1)              
 432   1        {
 433   2          MySTC_OS();    
 434   2        } 
 435   1      }               


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2897    ----
   CONSTANT SIZE    =    556    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     60    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
